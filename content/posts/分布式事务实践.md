+++
date = '2025-07-04T15:41:18+08:00'
draft = true
title = '分布式事务实践'
+++

## 实践

1. [订单代码](https://github.com/MinMallGo/srv/blob/main/orderSrv/handler/order.go)
2. [库存代码](https://github.com/MinMallGo/srv/blob/main/inventorySrv/handler/inventory.go)

## 思路
主要是就是核心链路有需要订阅 order_error(普通消息),order_cancel(延时消息)。以及订阅 订单创建的 事务消息 来进行订单下游的处理
### 订单服务侧

1. 订单发送半事务消息
2. 执行本地订单事务
    1. 创建订单
    2. 清空勾选的购物车
    3. 发送订单延时消息
3. 本地事务提交并 COMMIT这个半事务消息
4. ==================
5. 启动的时候订阅 order_error ，有消息说明订单核心链路失败，则需要作废订单

### 库存服务侧  通过 orderSN来保证幂等性

1. subscribe 订单的事务消息 topic 以及 order_error的topic
2. 发现有消息来了就解析消息种的信息，获取到orderSN,以及商品和数量等信息
3. 执行库存扣减
    1. 悲观锁扣减
    2. 乐观锁扣减
    3. 红锁扣减
4. 完成
5. ==================
6. 如果失败，则发送一条消息到 order_error 来让订单作废

### 抽象思路图
```text 
[订单服务]
   |
   | BeginTransaction -> RocketMQ 半消息(order_created)
   |
   | 本地事务: 创建订单 + 清购物车
   | COMMIT事务消息(order_created)
   |--> Send 延迟消息(order_cancel, 30min)
   |
   |<-- [order_error] ← 来自库存、优惠券服务失败时发送
   ↓
  标记订单作废

[库存服务]
   |
   |<-- [order_created] ← 消费事务消息
   |--> 扣减库存（幂等）
   |--> fail 发送 order_error

[优惠券服务 / 积分服务]
   |
   |<-- 同上
   |--> 使用资源
   |--> fail 发送 order_error

[支付服务]
   |
   |<-- [order_created]
   |--> 成功支付后，发送 order_paid
   |
   |<-- [order_cancel]
   |--> 如果未支付，做库存归还

[消息体字段：orderSN + 商品快照 + 用户ID + 下单时间 + 状态变更]
```