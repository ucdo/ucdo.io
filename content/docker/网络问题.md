+++
date = '2025-07-11T15:12:00+08:00'
draft = true
title = '网络问题'
+++

# 相关命令行
1. 查看创建的网络 `docker network ls`
2. 创建临时容器排查问题：`docker run --rm --network=kong_kong-network alpine:3.18 sh -c "apk add --no-cache bind-tools && dig @consul -p 8600 goods-api.service.consul"`

# 问题描述：[Kong 的所有 DNS 查询，都发到 Consul 的 8600 端口]
在使用**kong** 当作网关的时候，尝试使用 **DNS** 来连接 consul 做服务发现，但是迟迟就请不到。  
在docker-compose中添加了如下配置：  
```shell
      KONG_DNS_RESOLVER: consul-name:8600 # 最开始写的127.0.0.1:8600 但是不行，然后替换成这个，还是不行
```
再运行：  `docker-compose up kong-cp -d` 出现了以下错误：  
`2025/07/11 06:40:06 [crit] 1322#0: *6122 [lua] init.lua:248: init(): failed loading list of upstreams: failed to get from node cache: [postgres] [cosocket] DNS resolution failed: failed to receive reply from UDP server 127.0.0.1:8600: connection refused. Tried: ["(short)kong-ee-database:(na) - cache-miss","kong-ee-database:33 - cache-miss/querying"], context: ngx.timer`
  
然后查看 `my-consul` 在容器里面的实际ip地址，` docker inspect -f '{{range.NetworkSettings.Networks}}{{.IPAddress}}{{end}}' container_id`，改成 `KONG_DNS_RESOLVER: ip:8600`
错误描述：  
```text
2025/07/11 06:58:45 [warn] 1320#0: *904 [lua] connector.lua:350: unable to fetch current timestamp from PostgreSQL database ([cosocket] DNS resolution failed: failed to receive reply from UDP server 172.17.0.5:8600: timeout. Tried: ["(short)kong-ee-database:(na) - cache-miss","kong-ee-database:33 - cache-miss/querying"]), context: ngx.timer
```  
  
发现它在解析 `postgreSQL` 的时候也是走了`consul` 的DNS解析，发现找不到

# 解决问题 - gpt
`设置了 DNS_resolver，但 Kong 实际上在解析 kong-ee-database，这个名字是 Compose 提供的，而不是 Consul` -- gpt  
`你现在其实 不应该用 Consul 解析 kong-ee-database 这种 Compose 服务名。Kong 默认用系统 DNS 来解析服务名，如果你强制所有解析都走 Consul，就会造成局部 DNS 不通（因为 Consul 只能解析注册过的服务）。` --gpt  
修改配置为：
`KONG_DNS_RESOLVER: consul_ip:8600, 127.0.0.11`  

# 原因
因为 kong 的所有 DNS解析都走了consul，但是consul里面没有这个东西，所以额外加上一个本地的地址 127.0.0.11 ，就是说在consul中找不到就在 127.0.0.11中找

# 新的问题
配置好了之后。`docker-compose up kong-cp -d`。在server中配置了`goods-api.service.consul.`但是抛出错误 `DNS error code #3: Name Error (NXDOMAIN):`

# 解决问题
其实就是没有在一个网络导致的问题。在写dockerfile的时候，创建网络的时候，要加入到同一个才行。  
或者直接写dockerfile.yaml